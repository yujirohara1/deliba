C:\Users\yujir>psql -U postgres deliba_db
ユーザ postgres のパスワード:yjrhr1102

Heroku CLI heroku pg:psql postgresql-cylindrical-36948 --app deliba
heroku pg:psql postgresql-solid-08326 --app deliba




deliba_db=# select setval('customer_id_seq',(select max(id) from customer));
 setval
--------
   1070
(1 行)


deliba_db=# select setval('item_id_seq',(select max(id) from item));
 setval
--------
    412
(1 行)




住所３にlistを入れる



 drop view v_daicho_a;
 create view v_daicho_a as
 SELECT customer.group_id,
    customer.list,
    daicho.customer_id,
    '1' AS tenpo,
    customer.name1 AS cname1,
    customer.name2 AS cname2,
    customer.address1,
    customer.address2,
    customer.address3,
    customer.harai_kb,
    customer.del_flg AS cdelflg,
    daicho.item_id,
    item.code AS icode,
    item.name1 AS iname1,
    item.name2 AS iname2,
    item.tanka,
    item.del_flg AS idelflg,
    sum(
        CASE
            WHEN daicho.youbi = 1 THEN daicho.quantity
            ELSE 0
        END) AS getu,
    sum(
        CASE
            WHEN daicho.youbi = 2 THEN daicho.quantity
            ELSE 0
        END) AS ka,
    sum(
        CASE
            WHEN daicho.youbi = 3 THEN daicho.quantity
            ELSE 0
        END) AS sui,
    sum(
        CASE
            WHEN daicho.youbi = 4 THEN daicho.quantity
            ELSE 0
        END) AS moku,
    sum(
        CASE
            WHEN daicho.youbi = 5 THEN daicho.quantity
            ELSE 0
        END) AS kin,
    sum(
        CASE
            WHEN daicho.youbi = 6 THEN daicho.quantity
            ELSE 0
        END) AS dou,
    sum(
        CASE
            WHEN daicho.youbi = 7 THEN daicho.quantity
            ELSE 0
        END) AS niti,
    sum(daicho.quantity) AS total
   FROM daicho
     LEFT JOIN customer ON daicho.customer_id = customer.id
     LEFT JOIN item ON daicho.item_id = item.id
  WHERE customer.list IS NOT NULL AND customer.del_flg = 0
  GROUP BY customer.group_id, customer.list, daicho.customer_id, customer.name1, customer.name2, customer.address1, customer.address2, customer.address3, customer.harai_kb, customer.del_flg, daicho.item_id, item.code, item.name1, item.name2, item.tanka, item.del_flg
  ORDER BY customer.group_id, customer.list, item.code;
  

select * from v_daicho_a where customer_id = 1071;





drop table seikyu;
create table seikyu (
  customer_id integer not null,
  deliver_ymd date    not null,
  item_id     integer not null,
  price       integer not null,
  price_sub   integer ,
  quantity    integer not null,
  user_id     varchar(20) not null,
  ymdt        timestamp  not null
);











drop view v_seikyu_b;

CREATE VIEW v_seikyu_b
AS 
SELECT
    to_char(seikyu.deliver_ymd::timestamp with time zone, 'yyyy'::text) AS nen,
    to_char(seikyu.deliver_ymd::timestamp with time zone, 'mm'::text) AS tuki,
    customer.group_id,
    customer.list,
    customer.id customer_id,
    customer.name1,
    customer.biko2 zei_kb,
    CASE
      WHEN customer.biko2 = '2' THEN  sum(seikyu.price * seikyu.quantity) 
      ELSE cast( sum(seikyu.price * seikyu.quantity) * 1.08 as int) 
    END getugaku,
    CASE
      WHEN customer.biko2 = '2' THEN 0
      ELSE cast( sum(seikyu.price * seikyu.quantity) * 0.08 as int) 
    END zeigaku,
    to_char(max(ymdt),'yyyy/mm/dd HH24:MI:SS') max_ymdt
FROM
    seikyu
left outer join customer
on
    customer.id = seikyu.customer_id
WHERE
    list IS NOT NULL
group by
    to_char(seikyu.deliver_ymd::timestamp with time zone, 'yyyy'::text) ,
    to_char(seikyu.deliver_ymd::timestamp with time zone, 'mm'::text),
    customer.id,
    customer.name1,
    customer.name2,
    customer.list,
    customer.group_id,
    customer.harai_kb,
    customer.biko2 
ORDER BY
    to_char(seikyu.deliver_ymd::timestamp with time zone, 'yyyy'::text),
    to_char(seikyu.deliver_ymd::timestamp with time zone, 'mm'::text) ,
    customer.list,
    customer.id
;


select * from v_seikyu_b;





drop view v_seikyu_c;

CREATE VIEW v_seikyu_c
AS 
select
    nen || '.' || tuki || '' nengetu,
    sum(getugaku) getugaku,
    sum(zeigaku) zeigaku,
    max(max_ymdt) max_ymdt,
    sum(ninzu) ninzu
from
    (SELECT
        nen,
        tuki,
        sum(getugaku) getugaku,
        sum(zeigaku) zeigaku,
        max(max_ymdt) max_ymdt,
        count(1) ninzu
    FROM
        v_seikyu_b
    group by
        nen,
        tuki
    union all
    select
        to_char((date_trunc('month', current_date) + interval '0 month'),'yyyy') nen,
        to_char((date_trunc('month', current_date) + interval '0 month'),'mm') tuki,
        0,
        0,
        null,
        0
    union all
    select
        to_char((date_trunc('month', current_date) + interval '1 month'),'yyyy') nen,
        to_char((date_trunc('month', current_date) + interval '1 month'),'mm') tuki,
        0,
        0,
        null,
        0
    union all
    select
        to_char((date_trunc('month', current_date) + interval '2 month'),'yyyy') nen,
        to_char((date_trunc('month', current_date) + interval '2 month'),'mm') tuki,
        0,
        0,
        null,
        0
    ) a
group by
    nen,
    tuki
ORDER BY
    nen,
    tuki
;

select * from v_seikyu_c;










drop view v_seikyu_a;

CREATE VIEW v_seikyu_a
AS 
 SELECT sei.customer_id,
    to_char(sei.deliver_ymd::timestamp with time zone, 'yyyy'::text) AS nen,
    to_char(sei.deliver_ymd::timestamp with time zone, 'mm'::text) AS tuki,
    sei.item_id,
    item.name1 AS item_name1,
    sei.price,
    sei.price_sub,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '01'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d01,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '02'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d02,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '03'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d03,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '04'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d04,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '05'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d05,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '06'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d06,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '07'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d07,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '08'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d08,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '09'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d09,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '10'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d10,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '11'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d11,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '12'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d12,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '13'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d13,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '14'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d14,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '15'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d15,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '16'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d16,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '17'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d17,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '18'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d18,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '19'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d19,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '20'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d20,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '21'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d21,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '22'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d22,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '23'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d23,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '24'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d24,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '25'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d25,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '26'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d26,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '27'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d27,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '28'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d28,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '29'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d29,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '30'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d30,
    sum(
        CASE
            WHEN to_char(sei.deliver_ymd::timestamp with time zone, 'dd'::text) = '31'::text THEN sei.quantity
            ELSE NULL::integer
        END) AS quantity_d31,
    item.name1 AS item_name1_end
   FROM seikyu sei,
    item
  WHERE sei.item_id = item.id
  GROUP BY sei.customer_id, sei.item_id, sei.price, sei.price_sub, item.name1, (to_char(sei.deliver_ymd::timestamp with time zone, 'yyyy'::text)), (to_char(sei.deliver_ymd::timestamp with time zone, 'mm'::text));












